#!/bin/sh

# Abort on any error
set -e

LOG_FILE="$(mktemp -t elfiee-make-fmt.XXXXXX)"
STASHED=0

cleanup() {
    if [ "$STASHED" -eq 1 ]; then
        git stash pop -q || {
            echo "âš ï¸  Failed to restore stashed changes. Please run 'git stash pop' manually."
        }
    fi
    rm -f "$LOG_FILE"
}

trap cleanup EXIT

# Stash unstaged changes so formatting only touches staged files.
if ! git diff --quiet --ignore-submodules --; then
    if git stash push --keep-index -q -m "pre-commit-format"; then
        STASHED=1
    else
        echo "âŒ Unable to stash unstaged changes. Aborting commit."
        exit 1
    fi
fi

echo "ğŸ›   Running make fmt before commit..."

if ! make fmt >"$LOG_FILE" 2>&1; then
    cat "$LOG_FILE"
    echo "âŒ make fmt failed. Please fix the issues above."
    exit 1
fi

if ! git diff --quiet; then
    cat "$LOG_FILE"
    echo "âœ¨ make fmt applied formatting changes."
    echo "ğŸ‘‰ Please review, stage, and re-run git commit."
    exit 1
fi

echo "âœ… Formatting check passed."
