//! Tests for Directory extension
//!
//! Generated by elfiee-ext-gen - Implement the TODO markers.
//!
//! Test categories included:
//! - Payload deserialization tests
//! - Basic capability functionality tests
//! - Authorization/CBAC tests
//! - Integration workflow tests


use super::*;
use crate::capabilities::registry::CapabilityRegistry;
use crate::capabilities::grants::GrantsTable;

use crate::models::{Block, Command};
use tempfile::TempDir;

// ============================================
// DirectoryList - Payload Tests
// ============================================

#[test]
fn test_list_payload_deserialize() {
    // TODO: After defining Payload fields in mod.rs, fill in example JSON
    let json = serde_json::json!({
        // 故意缺少 "root" 字段，触发反序列化错误
        "recursive": true,
        "include_hidden": false,
        "max_depth": 2
    });

    let result: Result<DirectoryListPayload, _> = serde_json::from_value(json);
    assert!(result.is_ok(), "Payload should deserialize successfully");
    
    let payload = result.unwrap();
    assert_eq!(payload.root, "/tmp/project");
    assert!(payload.recursive);
    assert!(!payload.include_hidden);
    assert_eq!(payload.max_depth, Some(2));
}

// ============================================
// DirectoryList - Functionality Tests
// ============================================

#[test]
fn test_list_basic() {
    let temp_dir = TempDir::new().expect("create temp dir");
    let root_path = temp_dir.path();

    let registry = CapabilityRegistry::new();
    let cap = registry
        .get("directory.list")
        .expect("directory.list should be registered");

    let block = Block::new(
        "Test Block".to_string(),
        "directory".to_string(),
        "alice".to_string(),
    );

    let cmd = Command::new(
        "alice".to_string(),
        "directory.list".to_string(),
        block.block_id.clone(),
        serde_json::json!({
         "root": root_path.display().to_string(),
         "recursive": false,
         "include_hidden": false
        }),
    );

    // TODO: After implementing handler, this should pass
    let result = cap.handler(&cmd, Some(&block));
    assert!(result.is_ok(), "Handler should execute successfully");

    let events = result.unwrap();
    assert_eq!(events.len(), 1, "Should generate one event");
    assert_eq!(events[0].entity, block.block_id);
    assert_eq!(events[0].attribute, "alice/directory.list");

    // TODO: Add assertions to verify event contents
    // let contents = events[0].value.get("contents").unwrap();
    // assert_eq!(contents.get("field"), expected_value);
}


// ============================================
// DirectoryList - Authorization Tests
// ============================================

#[test]
fn test_list_authorization_owner() {
    let grants_table = GrantsTable::new();

    let block = Block::new(
        "Test Block".to_string(),
        "directory".to_string(),
        "alice".to_string(),
    );

    // Owner should always be authorized
    let is_authorized = block.owner == "alice"
        || grants_table.has_grant("alice", "directory.list", &block.block_id);

    assert!(is_authorized, "Block owner should be authorized");
}

#[test]
fn test_list_authorization_non_owner_without_grant() {
    let grants_table = GrantsTable::new();

    let block = Block::new(
        "Test Block".to_string(),
        "directory".to_string(),
        "alice".to_string(),
    );

    // Bob (non-owner) without grant should not be authorized
    let is_authorized = block.owner == "bob"
        || grants_table.has_grant("bob", "directory.list", &block.block_id);

    assert!(!is_authorized, "Non-owner without grant should not be authorized");
}

#[test]
fn test_list_authorization_non_owner_with_grant() {
    let mut grants_table = GrantsTable::new();

    let block = Block::new(
        "Test Block".to_string(),
        "directory".to_string(),
        "alice".to_string(),
    );

    // Grant Bob permission
    grants_table.add_grant(
        "bob".to_string(),
        "directory.list".to_string(),
        block.block_id.clone(),
    );

    let is_authorized = block.owner == "bob"
        || grants_table.has_grant("bob", "directory.list", &block.block_id);

    assert!(is_authorized, "Non-owner with grant should be authorized");
}




// ============================================
// Integration Workflow Test
// ============================================

#[test]
fn test_full_workflow() {
    // TODO: Implement a complete workflow test that exercises multiple capabilities
    // This test should demonstrate a realistic usage scenario

    let registry = CapabilityRegistry::new();
    let mut block = Block::new(
        "Workflow Test Block".to_string(),
        "directory".to_string(),
        "alice".to_string(),
    );

    // TODO: Step 1 - Use first capability
    // Example: create/add an item

    // TODO: Step 2 - Update block state (simulate StateProjector)
    // block.contents = events[0].value.get("contents").unwrap().clone();

    // TODO: Step 3 - Use second capability on updated state
    // Example: toggle/modify the item

    // TODO: Step 4 - Verify final state
    // assert_eq!(final_state, expected_state);

    todo!("Implement complete workflow test with multiple capability interactions");
}
