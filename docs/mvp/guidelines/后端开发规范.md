# Elfiee åç«¯å¼€å‘è§„èŒƒ

> æœ¬æ–‡æ¡£æ˜¯åç«¯å¼€å‘çš„**å”¯ä¸€çœŸç†æ¥æº**ï¼ŒåŒ…å«æ ¸å¿ƒè§„åˆ™ã€ä»£ç æ¨¡ç‰ˆå’Œè‡ªæŸ¥æ¸…å•ã€‚

## ğŸ”´ æ ¸å¿ƒç¡¬æ€§è§„åˆ™ (Critical Rules)

1.  **Tooling First**:
    *   âŒ ä¸¥ç¦æ‰‹åŠ¨åˆ›å»ºæ‰©å±•æ–‡ä»¶ï¼Œé™¤é `elfiee-ext-gen` ç¡®å®æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚
    *   âœ… å¿…é¡»ä¼˜å…ˆå°è¯• `elfiee-ext-gen create`ã€‚å¦‚æœå¿…é¡»æ‰‹åŠ¨åˆ›å»ºï¼Œ**å¿…é¡»**äº‹åè¿è¡Œ `elfiee-ext-gen validate`ã€‚
2.  **Double Registration**:
    *   âŒ ä¸¥ç¦åªåœ¨ä¸€ä¸ªåœ°æ–¹æ³¨å†Œå‘½ä»¤ã€‚
    *   âœ… å¿…é¡»åœ¨ `src-tauri/src/lib.rs` çš„ `cfg(debug_assertions)` **å’Œ** `cfg(not(debug_assertions))` ä¸¤ä¸ªå—ä¸­åŒæ—¶æ³¨å†Œã€‚
3.  **Entity ID Rule**:
    *   **Write Capability**: `Event.entity` å¿…é¡»æ˜¯ `block_id` (è¢«ä¿®æ”¹çš„ç›®æ ‡å—)ã€‚
    *   **Read Capability**: `Event.entity` å¿…é¡»æ˜¯ `editor_id` (æ‰§è¡Œè¯»å–æ“ä½œçš„ actor)ã€‚
4.  **Payloads**:
    *   âŒ ä¸¥ç¦ä½¿ç”¨ `cmd.payload.get("field")` æ‰‹åŠ¨è§£æã€‚
    *   âœ… å¿…é¡»å®šä¹‰ Struct å¹¶ `#[derive(Type, Serialize, Deserialize)]`ã€‚

---

## ğŸ§© æ ‡å‡†ä»£ç æ¨¡ç‰ˆ (Code Patterns)

### 1. æ‰©å±•è„šæ‰‹æ¶ (Extension Scaffolding)

AI åœ¨å¼€å§‹ä»»ä½•åç«¯ä»»åŠ¡å‰ï¼Œåº”ä¼˜å…ˆä½¿ç”¨æ­¤å·¥å…·ï¼š

```bash
# 1. åˆ›å»ºè„šæ‰‹æ¶ (TDD æ¨¡å¼)
# -n: åç§°, -b: å—ç±»å‹, -c: èƒ½åŠ›åˆ—è¡¨
elfiee-ext-gen create -n my_ext -b my_type -c action1,action2

# 2. è·å–å¼€å‘æŒ‡å¼•
elfiee-ext-gen guide my_ext

# 3. è¿è¡Œæµ‹è¯•
cd src-tauri
cargo test my_ext::tests -- --nocapture
```

### 2. å‘½ä»¤æ³¨å†Œæ¨¡ç‰ˆ (åœ¨ `lib.rs`)

```rust
// src-tauri/src/lib.rs

// 1. Debug Block (ç”¨äºç”Ÿæˆç±»å‹)
#[cfg(debug_assertions)]
let builder = {
    let specta_builder = tauri_specta::Builder::<tauri::Wry>::new()
        .commands(tauri_specta::collect_commands![
            // ... ç°æœ‰å‘½ä»¤
            commands::my_module::my_new_command, // <--- åœ¨æ­¤æ·»åŠ 
        ])
        .typ::<commands::my_module::MyPayload>() // <--- åœ¨æ­¤æ³¨å†Œç±»å‹
        // ...
};

// 2. Release Block (ç”¨äºç”Ÿäº§åŒ…)
#[cfg(not(debug_assertions))]
let builder = builder.invoke_handler(tauri::generate_handler![
    // ... ç°æœ‰å‘½ä»¤
    commands::my_module::my_new_command, // <--- å¿…é¡»åœ¨æ­¤åŒæ­¥æ·»åŠ 
]);
```

### 3. Capability Handler æ¨¡ç‰ˆ

```rust
// src/extensions/my_extension/mod.rs

#[derive(Debug, Clone, Serialize, Deserialize, Type)]
pub struct MyPayload {
    pub content: String,
}

#[capability(id = "my.write", target = "my_type")]
fn handle_write(cmd: &Command, block: Option<&Block>) -> CapResult<Vec<Event>> {
    let block = block.ok_or("Block required")?;
    
    // 1. å®‰å…¨è§£æ Payload
    let payload: MyPayload = serde_json::from_value(cmd.payload.clone())?;
    
    // 2. åˆ›å»ºäº‹ä»¶ (ä¸è¦ç›´æ¥ä¿®æ”¹ block å†…å­˜å¯¹è±¡)
    let event = create_event(
        block.block_id.clone(), // Writeæ“ä½œ: Entity = block_id
        cmd.cap_id.as_str(),
        json!({ "content": payload.content }),
        &cmd.editor_id,
        1
    )?;
    
    Ok(vec![event])
}
```

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„æ¦‚å¿µ

### Actor Model & Event Sourcing
*   **Engine Actor**: ä¸²è¡Œå¤„ç† Commandï¼Œä¿è¯æ— é”å¹¶å‘ã€‚
*   **Event Sourcing**: çŠ¶æ€æ˜¯ Events çš„æŠ•å½±ã€‚ä¸¥ç¦ç»•è¿‡ Event ç›´æ¥ä¿®æ”¹ Stateã€‚
*   **Vector Clock**: å†²çªè§£å†³æœºåˆ¶ï¼Œç”± Engine è‡ªåŠ¨å¤„ç†ã€‚

### Capability System (CBAC)
*   **Owner**: æ‹¥æœ‰æ‰€æœ‰æƒé™ã€‚
*   **Grant**: é Owner éœ€è¦æ˜¾å¼æˆæƒ (`GrantsTable`)ã€‚

---

## ğŸ åç«¯è‡ªæŸ¥æ¸…å• (Checklist)

> æäº¤ä»£ç å‰ï¼Œè¯·æ£€æŸ¥æ˜¯å¦è¿åä»¥ä¸‹æ¨¡å¼ï¼š

| æ£€æŸ¥é¡¹ | è¿è§„æ¨¡å¼ (å¦‚æœä½ å†™äº†è¿™äº›ï¼Œè¯·ä¿®æ­£) | æ­£ç¡®æ¨¡å¼ |
|:---|:---|:---|
| **æ³¨å†Œ** | å‘½ä»¤åªåœ¨ `debug` å—æ³¨å†Œ | Debug/Release åŒæ³¨å†Œ |
| **ç±»å‹** | Payload ä½¿ç”¨ `serde_json::Value` | å®šä¹‰å¼ºç±»å‹ Struct |
| **æ¶æ„** | Read èƒ½åŠ›çš„ Entity ç”¨äº† `block_id` | Read ç”¨ `editor_id` |
| **æ¶æ„** | Write èƒ½åŠ›çš„ Entity ç”¨äº† `editor_id` | Write ç”¨ `block_id` |
| **çŠ¶æ€** | ç›´æ¥ä¿®æ”¹ `block.fields` | è¿”å› `create_event` |
| **æµç¨‹** | æ‰‹åŠ¨åˆ›å»ºæ–‡ä»¶ | `elfiee-ext-gen create` |
